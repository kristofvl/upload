!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.Puck=t()}("undefined"!=typeof self?self:this,function(){if("undefined"!=typeof navigator){var e,t,n=[],i="6e400001-b5a3-f393-e0a9-e50e24dcca9e",o="6e400002-b5a3-f393-e0a9-e50e24dcca9e",r="6e400003-b5a3-f393-e0a9-e50e24dcca9e",a=16,c={debug:1,flowControl:!0,log:function(e,t){e<=this.debug&&console.log("<BLE> "+t)},writeProgress:function(e,t){},connect:f,write:l,eval:function(t,i){if(s())return e?(u(3,"Busy - adding Puck.eval to queue"),void n.push({type:"eval",expr:t,cb:i})):void l("Bluetooth.println(JSON.stringify("+t+"))\n",function(e){try{var t=JSON.parse(e);i(t)}catch(t){u(1,"Unable to decode "+JSON.stringify(e)+", got "+t.toString()),i(null,"Unable to decode "+JSON.stringify(e)+", got "+t.toString())}},!0)},setTime:function(e){var t=new Date,n="setTime("+t.getTime()/1e3+");";l(n+="if (E.setTimeZone) E.setTimeZone("+t.getTimezoneOffset()/-60+");\n",e)},isConnected:function(){return void 0!==t},getConnection:function(){return t},close:function(){t&&t.close()},modal:function(e){var t=document.createElement("div");t.style="position:absolute;top:0px;left:0px;right:0px;bottom:0px;opacity:0.5;z-index:100;background:black;",t.innerHTML='<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-family: Sans-Serif;font-size:400%;color:white;">Click to Continue...</div>',t.onclick=function(n){e(),n.preventDefault(),document.body.removeChild(t)},document.body.appendChild(t)}};return c}function s(){return navigator.platform.indexOf("Win")>=0&&(navigator.userAgent.indexOf("Chrome/54")>=0||navigator.userAgent.indexOf("Chrome/55")>=0||navigator.userAgent.indexOf("Chrome/56")>=0)?(console.warn("Chrome <56 in Windows has navigator.bluetooth but it's not implemented properly"),confirm("Web Bluetooth on Windows is not yet available.\nPlease click Ok to see other options for using Web Bluetooth")&&(window.location="https://www.espruino.com/Puck.js+Quick+Start"),!1):!!navigator.bluetooth||(console.warn("No Web Bluetooth on this platform"),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?confirm("To use Web Bluetooth on iOS you'll need the WebBLE App.\nPlease click Ok to go to the App Store and download it.")&&(window.location="https://itunes.apple.com/us/app/webble/id1193531073"):confirm("This Web Browser doesn't support Web Bluetooth.\nPlease click Ok to see instructions for enabling it.")&&(window.location="https://www.espruino.com/Puck.js+Quick+Start"),!1)}function u(e,t){c.log&&c.log(e,t)}function d(){if(n.length){var e=n.shift();u(3,"Executing "+JSON.stringify(e)+" from queue"),"eval"==e.type?c.eval(e.expr,e.cb):"write"==e.type?c.write(e.data,e.callback,e.callbackNewline):u(1,"Unknown queue item "+JSON.stringify(e))}}function f(t){if(s()){var d,f,l,v={on:function(e,t){this["on"+e]=t},emit:function(e,t){this["on"+e]&&this["on"+e](t)},isOpen:!1,isOpening:!0,txInProgress:!1},g=void 0,h=[],p=!1;return v.close=function(){v.isOpening=!1,v.isOpen?(v.isOpen=!1,v.emit("close")):t&&t(null),g&&(g.disconnect(),g=void 0,f=void 0,l=void 0)},v.write=function(e,t){e&&h.push({data:e,callback:t,maxLength:e.length}),v.isOpen&&!v.txInProgress&&function e(){if(p)return void setTimeout(e,50);var t;if(!h.length)return void c.writeProgress();var n=h[0];c.writeProgress(n.maxLength-n.data.length,n.maxLength);n.data.length<=a?(t=n.data,n.data=void 0):(t=n.data.substr(0,a),n.data=n.data.substr(a));v.txInProgress=!0;u(2,"Sending "+JSON.stringify(t));f.writeValue(function(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),i=0,o=e.length;i<o;i++)n[i]=e.charCodeAt(i);return t}(t)).then(function(){u(3,"Sent"),n.data||(h.shift(),n.callback&&n.callback()),v.txInProgress=!1,e()}).catch(function(e){u(1,"SEND ERROR: "+e),h=[],v.close()})}()},navigator.bluetooth.requestDevice({filters:[{namePrefix:"Puck.js"},{namePrefix:"Pixl.js"},{namePrefix:"MDBT42Q"},{namePrefix:"RuuviTag"},{namePrefix:"iTracker"},{namePrefix:"Thingy"},{namePrefix:"Espruino"},{services:[i]}],optionalServices:[i]}).then(function(e){u(1,"Device Name:       "+e.name),u(1,"Device ID:         "+e.id),e.addEventListener("gattserverdisconnected",function(){u(1,"Disconnected (gattserverdisconnected)"),v.close()}),v.device=e,v.reconnect(t)}).catch(function(e){u(1,"ERROR: "+e),v.close()}),v.reconnect=function(t){v.device.gatt.connect().then(function(e){return u(1,"Connected"),g=e,e.getPrimaryService(i)}).then(function(e){return u(2,"Got service"),(d=e).getCharacteristic(r)}).then(function(e){return l=e,u(2,"RX characteristic:"+JSON.stringify(l)),l.addEventListener("characteristicvaluechanged",function(e){var t,n=e.target.value,i=(t=n.buffer,String.fromCharCode.apply(null,new Uint8Array(t)));if(c.flowControl)for(var o=0;o<i.length;o++){var r=i.charCodeAt(o),a=!0;19==r?(u(2,"XOFF received => pause upload"),p=!0):17==r?(u(2,"XON received => resume upload"),p=!1):a=!1,a&&(i=i.substr(0,o-1)+i.substr(o+1),o--)}u(3,"Received "+JSON.stringify(i)),v.emit("data",i)}),l.startNotifications()}).then(function(){return d.getCharacteristic(o)}).then(function(e){f=e,u(2,"TX characteristic:"+JSON.stringify(f))}).then(function(){v.txInProgress=!1,v.isOpen=!0,v.isOpening=!1,e=!1,n=[],t(v),v.emit("open"),v.write()}).catch(function(e){u(1,"ERROR: "+e),v.close()})},v}}function l(i,o,r){if(s()){if(e)return u(3,"Busy - adding Puck.write to queue"),void n.push({type:"write",data:i,callback:o,callbackNewline:r});var a;if(t&&(t.isOpen||t.isOpening))return t.txInProgress||(t.received=""),e=!0,t.write(i,c);t=f(function(n){if(!n)return t=void 0,void(o&&o(null));t.received="",t.on("data",function(e){t.received+=e,t.hadData=!0,t.cb&&t.cb(e)}),t.on("close",function(e){t=void 0}),e=!0,t.write(i,c)})}function c(){r&&(t.cb=function(n){var i=t.received.indexOf("\n");if(i>=0){var r=t.received.substr(0,i);t.received=t.received.substr(i+1),t.cb=void 0,a&&clearTimeout(a),a=void 0,o&&o(r),e=!1,d()}});var n=300,i=r?100:3,c=i;a=setTimeout(function r(){a=void 0,n&&n--,c&&c--,t.hadData&&(c=i),c&&n?a=setTimeout(r,100):(t.cb=void 0,o&&o(t.received),e=!1,d(),t.received=""),t.hadData=!1},100)}}});
